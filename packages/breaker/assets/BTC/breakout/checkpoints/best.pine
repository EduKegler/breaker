//@version=6
strategy("BTC 15m Breakout — Donchian ADX",
  overlay              = true,
  initial_capital      = 1000,
  default_qty_type     = strategy.cash,
  default_qty_value    = 100,
  commission_type      = strategy.commission.percent,
  commission_value     = 0.045,
  slippage             = 2,
  process_orders_on_close = false,
  calc_on_every_tick   = false,
  max_bars_back        = 5000)

// ── Free Variables (5) ──────────────────────────────────────────────
dcSlow         = 50       // Slow Donchian period for entry (30-60)
dcFast         = 20       // Fast Donchian period for trailing exit (10-25)
adxThreshold   = 25       // ADX below this = consolidation (20-35)
atrStopMult    = 2.0      // ATR multiplier for safety stop (1.5-3.0)
maxTradesDay   = 3        // Max trades per day (2-5)

// ── Structural Params (var — NOT counted) ───────────────────────────
var float riskTradeUsd = 10.0
var int   cooldownBars = 4
var float dailyLossUsd = 20.0

// ── Trend timeframe (protected) ─────────────────────────────────────
trendTf = "60"

// ── Indicators ──────────────────────────────────────────────────────
// Slow Donchian Channel (entry signal)
float dcSlowUpper = ta.highest(high, dcSlow)
float dcSlowLower = ta.lowest(low, dcSlow)

// Fast Donchian Channel (trailing exit)
float dcFastUpper = ta.highest(high, dcFast)
float dcFastLower = ta.lowest(low, dcFast)

// ADX (consolidation filter)
[diPlus, diMinus, adxVal] = ta.dmi(14, 14)

// ATR 1H (anti-repaint) — safety stop
float atr1h = request.security(syminfo.tickerid, trendTf, ta.atr(14)[1], lookahead = barmerge.lookahead_on)

// EMA 50 Daily — regime filter (anti-repaint)
float ema50_daily = request.security(syminfo.tickerid, "D", ta.ema(close, 50)[1], lookahead = barmerge.lookahead_on)
bool regimeBull = close > ema50_daily
bool regimeBear = close < ema50_daily

// ── State Variables ─────────────────────────────────────────────────
var int   barsSinceExit    = 999
var int   consecLosses     = 0
var float dailyPnl         = 0.0
var int   lastTradeDay     = 0
var int   prevClosedTrades = 0
var int   tradesToday      = 0

// ── Daily Reset ─────────────────────────────────────────────────────
tz = "America/New_York"
int today = dayofweek(time, tz)
if today != lastTradeDay
    dailyPnl     := 0.0
    tradesToday  := 0
    consecLosses := 0
    lastTradeDay := today

// ── Track Closed Trades ─────────────────────────────────────────────
if strategy.closedtrades > prevClosedTrades
    for i = prevClosedTrades to strategy.closedtrades - 1
        dailyPnl += strategy.closedtrades.profit(i)
    float lastPnl = strategy.closedtrades.profit(strategy.closedtrades - 1)
    if lastPnl < 0
        consecLosses += 1
    else
        consecLosses := 0
    prevClosedTrades := strategy.closedtrades
    barsSinceExit    := 0
else
    barsSinceExit += 1

// Track new entries for daily limit
if strategy.opentrades > 0 and strategy.opentrades[1] == 0
    tradesToday += 1

// ── Operational Limits ──────────────────────────────────────────────
bool cooldownOk   = barsSinceExit >= cooldownBars
bool noConsecLoss = consecLosses < 2
bool dailyLossOk  = dailyPnl > -dailyLossUsd
bool maxTradesOk  = tradesToday < maxTradesDay
bool canTrade     = cooldownOk and noConsecLoss and dailyLossOk and maxTradesOk

// ── Position Sizing ─────────────────────────────────────────────────
float stopDist    = nz(atr1h) * atrStopMult
float positionQty = stopDist > 0 ? riskTradeUsd / stopDist : 0

// ── Entry Rules ─────────────────────────────────────────────────────
// LONG: Donchian breakout up + ADX low + daily regime bullish
bool longSignal = canTrade and close > dcSlowUpper[1] and adxVal < adxThreshold and regimeBull and strategy.position_size == 0 and not na(atr1h)

// SHORT: Donchian breakout down + ADX low + daily regime bearish
bool shortSignal = canTrade and close < dcSlowLower[1] and adxVal < adxThreshold and regimeBear and strategy.position_size == 0 and not na(atr1h)

// ── Execute Entries ─────────────────────────────────────────────────
if longSignal
    float sl = close - stopDist
    strategy.entry("Long", strategy.long, qty = positionQty)
    strategy.exit("Long SL", "Long", stop = sl)

if shortSignal
    float sl = close + stopDist
    strategy.entry("Short", strategy.short, qty = positionQty)
    strategy.exit("Short SL", "Short", stop = sl)

// ── Trailing Exit via Fast Donchian ─────────────────────────────────
if strategy.position_size > 0 and close < dcFastLower[1]
    strategy.close("Long", comment = "DC Trail")

if strategy.position_size < 0 and close > dcFastUpper[1]
    strategy.close("Short", comment = "DC Trail")

// ── Plots ───────────────────────────────────────────────────────────
plot(dcSlowUpper, "DC Slow Upper", color.green, 2)
plot(dcSlowLower, "DC Slow Lower", color.red, 2)
plot(dcFastUpper, "DC Fast Upper", color.new(color.green, 70), 1)
plot(dcFastLower, "DC Fast Lower", color.new(color.red, 70), 1)
plot(ema50_daily, "EMA50 Daily", color.purple, 2)
