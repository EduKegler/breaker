//@version=6
strategy("BTC 15m Mean Reversion — Keltner RSI2",
  overlay              = true,
  initial_capital      = 1000,
  default_qty_type     = strategy.cash,
  default_qty_value    = 100,
  commission_type      = strategy.commission.percent,
  commission_value     = 0.045,
  slippage             = 2,
  process_orders_on_close = false,
  calc_on_every_tick   = false,
  max_bars_back        = 5000)

// ── Free Variables (5 — counted by countPineInputs) ─────────────────
kcMultiplier  = 2.0
rsi2Long      = 20
rsi2Short     = 80
maxTradesDay  = 3
timeoutBars   = 8

// ── Structural Params (var — NOT counted) ───────────────────────────
var float riskTradeUsd = 10.0
var int   cooldownBars = 4
var float dailyLossUsd = 20.0

// ── Trend timeframe (protected) ─────────────────────────────────────
trendTf = "60"

// ── Indicators ──────────────────────────────────────────────────────
// Keltner Channel: EMA(20) ± mult × ATR(14)
[kcMid, kcUpper, kcLower] = ta.kc(close, 20, kcMultiplier)

// RSI(2) — short-period for extreme oversold/overbought
float rsi2 = ta.rsi(close, 2)

// Volume SMA(20) for short entry quality gate
float volAvg20 = ta.sma(volume, 20)

// ATR 1H via request.security (anti-repaint)
float atr1h = request.security(syminfo.tickerid, trendTf, ta.atr(14)[1], lookahead = barmerge.lookahead_on)

// EMA(200) 1H regime filter — both directions (anti-repaint)
float ema200h = request.security(syminfo.tickerid, trendTf, ta.ema(close, 200)[1], lookahead = barmerge.lookahead_on)

// ── State Variables ─────────────────────────────────────────────────
var int   dayTrades      = 0
var int   barsSinceExit  = 999
var int   consecLosses   = 0
var float dailyPnl       = 0.0
var int   lastTradeDay   = 0
var int   prevClosedTrades = 0

// Reset daily trades at new UTC day
int todayUTC = dayofmonth(time, "UTC")
if todayUTC != lastTradeDay
    dayTrades    := 0
    consecLosses := 0
    dailyPnl     := 0.0
    lastTradeDay := todayUTC

// Track closed trades for PnL and consecutive losses
if strategy.closedtrades > prevClosedTrades
    for i = prevClosedTrades to strategy.closedtrades - 1
        dailyPnl += strategy.closedtrades.profit(i)
    float lastPnl = strategy.closedtrades.profit(strategy.closedtrades - 1)
    if lastPnl < 0
        consecLosses += 1
    else
        consecLosses := 0
    prevClosedTrades := strategy.closedtrades
    barsSinceExit    := 0
else
    barsSinceExit += 1

// ── Operational Limits ──────────────────────────────────────────────
bool cooldownOk  = barsSinceExit >= cooldownBars
bool dayCapOk    = dayTrades < maxTradesDay
bool noConsecLoss = consecLosses < 3
bool dailyLossOk = dailyPnl > -dailyLossUsd
bool canTrade    = cooldownOk and dayCapOk and noConsecLoss and dailyLossOk

// ── Position Sizing ─────────────────────────────────────────────────
float stopDist    = nz(atr1h) * 1.5
float positionQty = stopDist > 0 ? riskTradeUsd / stopDist : 0

// ── Entry Rules ─────────────────────────────────────────────────────
// LONG: close below KC lower band + RSI(2) oversold (no EMA200 direction gate)
bool longSignal = close < kcLower and rsi2 < rsi2Long and canTrade and strategy.position_size == 0 and not na(atr1h)

// SHORT: close above KC upper band + RSI(2) overbought + volume spike (no EMA200 direction gate)
bool shortVolOk  = volume > 1.5 * volAvg20
bool shortSignal = close > kcUpper and rsi2 > rsi2Short and shortVolOk and canTrade and strategy.position_size == 0 and not na(atr1h)

// ── Execute Entries ─────────────────────────────────────────────────
if longSignal
    float sl = close - stopDist
    float tp = kcMid
    strategy.entry("Long", strategy.long, qty = positionQty)
    strategy.exit("Long TP", "Long", limit = tp, stop = sl)
    dayTrades += 1

if shortSignal
    float sl = close + stopDist
    float tp1 = kcMid
    strategy.entry("Short", strategy.short, qty = positionQty)
    strategy.exit("Short TP1", "Short", limit = tp1, stop = sl, qty_percent = 60)
    strategy.exit("Short TP2", "Short", stop = sl)
    dayTrades += 1

// ── Timeout Exit ────────────────────────────────────────────────────
if strategy.position_size != 0 and bar_index - strategy.opentrades.entry_bar_index(0) >= timeoutBars
    strategy.close_all("Timeout")

// ── Plots ───────────────────────────────────────────────────────────
plot(kcMid,   "KC Mid",   color.yellow, 2)
plot(kcUpper, "KC Upper", color.new(color.green, 50))
plot(kcLower, "KC Lower", color.new(color.red, 50))
plot(ema200h, "EMA200 1H", color.new(color.white, 70), style = plot.style_stepline)
